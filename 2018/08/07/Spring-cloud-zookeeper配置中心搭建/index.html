<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Spring cloud zookeeper配置中心搭建 · TickTock Ideas</title><meta name="description" content="Spring cloud zookeeper config"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://charleywu.com/atom.xml" title="TickTock Ideas"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/CharleyWuCL" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Spring cloud zookeeper配置中心搭建</h1><div class="post-info">Aug 7, 2018</div><div class="post-content"><p>Spring cloud zookeeper提供了分布式配置中心以及注册中心的功能，可以使用其配置中心功能替代Spring cloud config。</p>
<p>由于是Spring出品，所以与Spring Boot应用集成非常简单，下面就让我们来了解一下其简单的使用方式。<br><a id="more"></a></p>
<p>###官方介绍</p>
<blockquote>
<p>Spring Cloud Zookeeper provides Apache Zookeeper integrations for Spring Boot apps through autoconfiguration and binding to the Spring Environment and other Spring programming model idioms. With a few simple annotations you can quickly enable and configure the common patterns inside your application and build large distributed systems with Zookeeper. The patterns provided include Service Discovery and Distributed Configuration. </p>
</blockquote>
<h3 id="系统架构图"><a href="#系统架构图" class="headerlink" title="系统架构图"></a>系统架构图</h3><p><img src="https://raw.githubusercontent.com/CharleyWuCL/charleywucl.github.io/master/images/blog/zookeeper/arch.png" alt="系统架构"></p>
<h3 id="依赖引入"><a href="#依赖引入" class="headerlink" title="依赖引入"></a>依赖引入</h3><p>Maven<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zookeeper-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>Gradle<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">compile(&apos;org.springframework.cloud:spring-cloud-starter-zookeeper-config:2.0.0.RELEASE&apos;)</div></pre></td></tr></table></figure></p>
<h3 id="系统配置"><a href="#系统配置" class="headerlink" title="系统配置"></a>系统配置</h3><p>bootstarp.xml<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">spring:</div><div class="line">  cloud:</div><div class="line">    zookeeper:</div><div class="line">      enabled: true #Is Zookeeper enabled</div><div class="line">      connect-string: localhost:2181 #Connection string to the Zookeeper cluster</div><div class="line">      max-retries: 3 #Max number of times to retry</div><div class="line">      config:</div><div class="line">        root: config/root #Root folder where the configuration for Zookeeper is kept</div><div class="line">        defaultContext: application #The name of the default context</div></pre></td></tr></table></figure></p>
<h3 id="代码演示"><a href="#代码演示" class="headerlink" title="代码演示"></a>代码演示</h3><p>启动时加载配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Example</span> </span>&#123;</div><div class="line">    <span class="comment">//Server level switch</span></div><div class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;server&#125;"</span>)</div><div class="line">    <span class="keyword">private</span> String serverEnabled;</div><div class="line"> </div><div class="line">    <span class="comment">//Feature level switch</span></div><div class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;feature.log&#125;"</span>)</div><div class="line">    <span class="keyword">private</span> String featureLogEnabled;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>配置更新时使用<code>@RefreshScope</code>自动刷新</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RefreshScope</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Example</span> </span>&#123;</div><div class="line">    <span class="comment">//Server level switch</span></div><div class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;server&#125;"</span>)</div><div class="line">    <span class="keyword">private</span> String serverEnabled;</div><div class="line"> </div><div class="line">    <span class="comment">//Feature level switch</span></div><div class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;feature.log&#125;"</span>)</div><div class="line">    <span class="keyword">private</span> String featureLogEnabled;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>###Zookeeper树</p>
<p><img src="https://raw.githubusercontent.com/CharleyWuCL/charleywucl.github.io/master/images/blog/zookeeper/Zookeeper-tree.png" alt="zk结构"></p>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><p>由于应用启动需要从ZK Server上去拉取配置，所以数据节点要预先在ZK上设置好，或者通过application.yml文件给定一个默认值，否则启动会报错。</p>
<h3 id="关于Zookeeper版本"><a href="#关于Zookeeper版本" class="headerlink" title="关于Zookeeper版本"></a>关于Zookeeper版本</h3><p><strong>3.5.x</strong></p>
<p>Spring-cloud-zookeeper目前最新版本依赖的zookeeper-client依赖树如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">spring-cloud-starter-zookeeper-config:2.0.0.RELEASE</div><div class="line">	|</div><div class="line">	|--curator-recipes:4.0.1</div><div class="line">	|</div><div class="line">	|--curator-framework:4.0.1</div><div class="line">	|		|</div><div class="line">	|		|--zookeeper:3.5.3-beta</div><div class="line">	|</div><div class="line">	|--curator-test:4.0.1</div><div class="line">	|		|</div><div class="line">	|		|--zookeeper:3.5.3-beta</div></pre></td></tr></table></figure>
<p>如果Zookeeper Server版本为3.5.x，则直接使用就可以。</p>
<p><strong>3.4.x</strong></p>
<p>如果Zookeeper Server版本为3.4.X，则需要手动进行Client断兼容。方法如下：</p>
<p>Maven</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- Curator Recipes --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-recipes<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- Curator Test --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.12.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- Zookeeper --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.x<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>Gradle</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">compile(&apos;org.apache.curator:curator-recipes:4.0.1) &#123;</div><div class="line">  exclude group: &apos;org.apache.zookeeper&apos;, module: &apos;zookeeper&apos;</div><div class="line">&#125;</div><div class="line">testCompile(&apos;org.apache.curator:curator-test:2.12.0&apos;) &#123;</div><div class="line">  exclude group: &apos;org.apache.zookeeper&apos;, module: &apos;zookeeper&apos;</div><div class="line">&#125;</div><div class="line">compile(&apos;org.apache.zookeeper:zookeeper:3.4.x&apos;)</div></pre></td></tr></table></figure>
<p><strong>特别注意</strong></p>
<p>如果要使用3.4.x版本的Zookeeper Client， 那么在使用<code>TestingServer</code>时只能依赖<code>org.apache.curator:curator-test:2.12.0</code></p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/08/08/Hexo-Apollo主题使用Gitment评论系统/" class="prev">PREV</a><a href="/2018/04/12/Kafka概述/" class="next">NEXT</a></div><div id="container"></div><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"><script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script><script>var gitment = new Gitment({
    id: 'Tue Aug 07 2018 12:33:27 GMT+0800',
    owner: 'CharleyWuCL',
    repo: 'charleywucl.github.io',
    oauth: {
        client_id: 'a3aebd7727cc175c2796',
        client_secret: '130cd80e9084e3fcd78d7dffd34c497c96f5b2cd',
    },
})
gitment.render('container')</script><div class="copyright"><p>© 2015 - 2018 <a href="http://charleywu.com">Charley Wu</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>